<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Previs√£o Meteorol√≥gica - IPMA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; transition: background-color 0.3s, color 0.3s; }
    .grafico-container { max-width: 700px; margin: 40px auto; height: 400px; position: relative; }
    canvas { width: 100% !important; height: 100% !important; min-height: 300px; }
    select, button { font-size: 16px; padding: 6px; margin-bottom: 10px; }
    #ventoInfo, #alertas, #riscoIncendio, #sismos { max-width: 700px; margin: 20px auto; font-size: 16px; }
    table { width: 100%; border-collapse: collapse; } th, td { padding: 8px; border: 1px solid #ccc; }
    th { background: #f0f0f0; } p.fallback { text-align: center; font-style: italic; color: #888; }

    body.dark-mode { background-color: #121212; color: #e0e0e0; }
    body.dark-mode h2, body.dark-mode h3, body.dark-mode label { color: #fff; }
    body.dark-mode table { background-color: #1e1e1e; color: #e0e0e0; }
    body.dark-mode th { background-color: #333; } body.dark-mode td { border-color: #444; }
    body.dark-mode a { color: #90caf9; } body.dark-mode button { background-color: #333; color: #fff; border: 1px solid #555; }

    @media (max-width: 768px) {
      body { padding: 10px; font-size: 16px; }
      h2, h3 { font-size: 20px; }
      select, button { width: 100%; font-size: 18px; padding: 10px; margin-bottom: 15px; }
      .grafico-container { height: 300px; }
      #sismos table { display: block; overflow-x: auto; white-space: nowrap; }
      #sismos th, #sismos td { font-size: 14px; padding: 6px; }
    }
  </style>
</head>
<body>
  <h2>üå§Ô∏è Previs√£o Meteorol√≥gica</h2>
  <button id="toggleDarkMode">üåô Alternar Modo Escuro</button>
  <label for="cidadeSelect">Escolhe uma cidade:</label>
  <select id="cidadeSelect"></select>

  <div id="alertas"></div>
  <div id="riscoIncendio"></div>

  <div class="grafico-container"><canvas id="graficoTemperaturas"></canvas></div>
  <div class="grafico-container"><canvas id="graficoPrecipitacao"></canvas></div>
  <div id="ventoInfo"></div>

  <div id="graficoUVWrapper" class="grafico-container">
    <canvas id="graficoUV"></canvas>
  </div>
  <p id="mensagemUV" class="fallback" style="display:none;">‚ùå Sem dados de √≠ndice UV dispon√≠veis.</p>

  <div id="graficoHumidadeWrapper" class="grafico-container">
    <canvas id="graficoHumidade"></canvas>
  </div>
  <p id="mensagemHumidade" class="fallback" style="display:none;">‚ùå Sem dados de humidade relativa dispon√≠veis.</p>

  <div id="sismos">
    <h3>üåç √öltimos 10 Sismos em Portugal Continental</h3>
    <table id="tabelaSismos">
      <thead>
        <tr>
          <th>üìÖ Data e Hora (UTC)</th>
          <th>üìç Localiza√ß√£o</th>
          <th>üìè Magnitude</th>
          <th>üìê Profundidade</th>
          <th>üåê Coordenadas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p style="text-align:center; font-size:14px; margin-top:10px;">
      Fonte: <a href="https://www.ipma.pt/pt/geofisica/sismicidade/" target="_blank">IPMA ‚Äì Mapa de Sismicidade</a>
    </p>
  </div>
<script>
document.getElementById('toggleDarkMode').addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
});

const select = document.getElementById('cidadeSelect');
let graficoTemperaturas, graficoPrecipitacao, graficoUV, graficoHumidade;

fetch('https://api.ipma.pt/open-data/distrits-islands.json')
  .then(res => res.json())
  .then(data => {
    data.data.forEach(cidade => {
      const opt = document.createElement('option');
      opt.value = cidade.globalIdLocal;
      opt.textContent = cidade.local;
      select.appendChild(opt);
    });

    // Carregamento inicial: Lisboa como exemplo (globalIdLocal: 1110600)
    select.value = 1110600;
    carregarPrevisao(select.value);
  });

select.addEventListener('change', () => {
  carregarPrevisao(select.value);
});
</script>
<script>
function carregarPrevisao(globalIdLocal) {
  const url = `https://api.ipma.pt/open-data/forecast/meteorology/cities/daily/${globalIdLocal}.json`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data.data) || data.data.length === 0) {
        console.warn("‚ùå API sem dados para globalIdLocal:", globalIdLocal);
        return;
      }

      const dias = data.data.slice(0, 5);
      const labels = dias.map(d => d.forecastDate);
      const tMin = dias.map(d => parseFloat(d.tMin));
      const tMax = dias.map(d => parseFloat(d.tMax));
      const precip = dias.map(d => parseInt(d.precipitaProb));

      const diasComUV = dias.filter(d => d.uv !== null);
      const uvLabels = diasComUV.map(d => d.forecastDate);
      const uvData = diasComUV.map(d => parseFloat(d.uv));
      while (uvLabels.length < 5) {
        uvLabels.push('');
        uvData.push(null);
      }

      const diasComHum = dias.filter(d => d.rhMin !== null && d.rhMax !== null);
      const humLabels = diasComHum.map(d => d.forecastDate);
      const humMin = diasComHum.map(d => parseInt(d.rhMin));
      const humMax = diasComHum.map(d => parseInt(d.rhMax));
      while (humLabels.length < 5) {
        humLabels.push('');
        humMin.push(null);
        humMax.push(null);
      }

      const cidadeNome = select?.options?.[select.selectedIndex]?.text || 'Cidade selecionada';

      if (graficoTemperaturas) graficoTemperaturas.destroy();
      graficoTemperaturas = new Chart(document.getElementById('graficoTemperaturas'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Temperatura M√≠nima (¬∞C)', data: tMin, backgroundColor: '#4e79a7' },
            { label: 'Temperatura M√°xima (¬∞C)', data: tMax, backgroundColor: '#f28e2b' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: `Temperaturas previstas para ${cidadeNome}` }
          },
          scales: { y: { beginAtZero: true } }
        }
      });

      if (graficoPrecipitacao) graficoPrecipitacao.destroy();
      graficoPrecipitacao = new Chart(document.getElementById('graficoPrecipitacao'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Precipita√ß√£o (%)',
            data: precip,
            borderColor: '#76b7b2',
            backgroundColor: 'rgba(118,183,178,0.2)',
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Precipita√ß√£o prevista' }
          },
          scales: { y: { beginAtZero: true, max: 100 } }
        }
      });

      if (uvData.some(v => v !== null)) {
        document.getElementById('graficoUVWrapper').style.display = 'block';
        document.getElementById('mensagemUV').style.display = 'none';
        if (graficoUV) graficoUV.destroy();
        graficoUV = new Chart(document.getElementById('graficoUV'), {
          type: 'line',
          data: {
            labels: uvLabels,
            datasets: [{
              label: '√çndice UV',
              data: uvData,
              borderColor: '#e15759',
              backgroundColor: 'rgba(225,87,89,0.2)',
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: { display: true, text: '√çndice UV previsto' }
            },
            scales: { y: { beginAtZero: true, max: 11 } }
          }
        });
      } else {
        document.getElementById('graficoUVWrapper').style.display = 'none';
        document.getElementById('mensagemUV').style.display = 'block';
      }

      if (humMin.some(v => v !== null) && humMax.some(v => v !== null)) {
        document.getElementById('graficoHumidadeWrapper').style.display = 'block';
        document.getElementById('mensagemHumidade').style.display = 'none';
        if (graficoHumidade) graficoHumidade.destroy();
        graficoHumidade = new Chart(document.getElementById('graficoHumidade'), {
          type: 'bar',
          data: {
            labels: humLabels,
            datasets: [
              { label: 'Humidade M√≠nima (%)', data: humMin, backgroundColor: '#59a14f' },
              { label: 'Humidade M√°xima (%)', data: humMax, backgroundColor: '#9c755f' }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: { display: true, text: 'Humidade Relativa' }
            },
            scales: { y: { beginAtZero: true, max: 100 } }
          }
        });
      } else {
        document.getElementById('graficoHumidadeWrapper').style.display = 'none';
        document.getElementById('mensagemHumidade').style.display = 'block';
      }

      const angulos = { N: 0, NE: 45, E: 90, SE: 135, S: 180, SW: 225, W: 270, NW: 315 };
      let ventoHTML = '<h3>üí® Dire√ß√£o e Intensidade do Vento</h3><div style="display:flex; flex-wrap:wrap; gap:10px;">';

      dias.forEach((d, i) => {
        const direcao = d.predWindDir;
        const intensidade = String(d.classWindSpeed || '').toLowerCase();
        const cor = intensidade.includes('forte') ? '#d62728' :
                    intensidade.includes('moderado') ? '#ff7f0e' : '#2ca02c';
        const angulo = angulos[direcao] ?? 0;

        ventoHTML += `
          <div style="flex:1; min-width:120px; background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #ccc; text-align:center;">
            <strong>${labels[i]}</strong><br>
            <svg width="40" height="40" style="transform: rotate(${angulo}deg); margin:10px 0;">
              <polygon points="20,5 25,20 20,15 15,20" fill="${cor}" />
            </svg>
            <span style="color:${cor}; font-weight:bold;">${intensidade}</span><br>
            <em>${direcao}</em>
          </div>
        `;
      });

      ventoHTML += '</div>';
      document.getElementById('ventoInfo').innerHTML = ventoHTML;

      carregarPainelAlerta(globalIdLocal);
      mostrarRiscoIncendio();
      carregarSismos();
    });
}
</script>

 <script>
function carregarPainelAlerta(globalIdLocalSelecionado) {
  const container = document.getElementById('alertas');
  container.innerHTML = '<h3>‚ö†Ô∏è Alertas Meteorol√≥gicos</h3>';

  // 1Ô∏è‚É£ Obter lista de distritos para localizar nome correto
  fetch('https://api.ipma.pt/open-data/distrits-islands.json')
    .then(res => res.json())
    .then(lista => {
      const entrada = lista?.data?.find(e => e.globalIdLocal == globalIdLocalSelecionado);
      if (!entrada) {
        container.innerHTML += '<p style="color:red;">‚ùå Distrito n√£o encontrado.</p>';
        return;
      }

      const nomeDistrito = entrada.local.trim().toUpperCase(); // ex: LISBOA

      // 2Ô∏è‚É£ Agora que temos nomeDistrito, podemos carregar tudo o resto
      Promise.all([
        fetch('https://api.ipma.pt/open-data/forecast/warnings/warnings_www.json').then(r => r.json()),
        fetch(`https://api.ipma.pt/open-data/forecast/meteorology/cities/daily/${globalIdLocalSelecionado}.json`).then(r => r.json()),
        fetch('https://api.ipma.pt/open-data/weather-type-classe.json').then(r => r.json())
      ])
      .then(([alertasData, previsaoData, tiposData]) => {
        const alertasVisiveis = Array.isArray(alertasData?.[nomeDistrito])
          ? alertasData[nomeDistrito]
          : [];

        // üì¶ Painel de debug opcional ‚Äî mostra dados brutos da API
        container.innerHTML += `
          <details style="margin-top:20px; background:#f0f0f0; padding:10px; border:1px solid #ccc;">
            <summary style="cursor:pointer; font-weight:bold;">üîç Ver dados brutos da API para ${nomeDistrito}</summary>
            <pre style="font-size:12px; white-space:pre-wrap;">${JSON.stringify(alertasVisiveis, null, 2)}</pre>
          </details>
        `;

        const tipoTempoId = previsaoData.data?.[0]?.idWeatherType;
        const fenomeno = tiposData?.data?.find(t => t.idWeatherType === tipoTempoId)?.descIdWeatherTypePT;

        let html = `<strong>${entrada.local}</strong><br>`;

        if (alertasVisiveis.length === 0) {
          html += '<p style="color:green;">‚úÖ Sem alertas meteorol√≥gicos ativos para este local.</p>';
        } else {
          html += '<ul>';
          alertasVisiveis.forEach(a => {
            const cor = {
              green: '#2ca02c',
              yellow: '#ffcc00',
              orange: '#ff7f0e',
              red: '#d62728'
            }[a.awarenessLevelID] || '#999';

            html += `
              <li style="margin-bottom:10px;">
                <strong>${a.awarenessTypeName || 'Alerta Meteorol√≥gico'}</strong><br>
                <span style="color:${cor}; font-weight:bold;">N√≠vel: ${a.awarenessLevelID?.toUpperCase() || '‚Äî'}</span><br>
                <em>${a.startTime} ‚Üí ${a.endTime}</em><br>
                ${a.text ? `<p>${a.text}</p>` : ''}
              </li>
            `;
          });
          html += '</ul>';
        }

        html += `<p>üìå Fen√≥meno previsto: <em>${fenomeno || "N√£o dispon√≠vel"}</em></p>`;
        container.innerHTML += html;
      })
      .catch(err => {
        console.error("‚ùå Falha ao obter dados da API:", err);
        container.innerHTML += '<p style="color:red;">‚ùå Erro ao carregar dados meteorol√≥gicos (ver consola).</p>';
      });
    })
    .catch(err => {
      console.error("‚ùå Erro ao obter distritos:", err);
      container.innerHTML += '<p style="color:red;">‚ùå Erro ao obter dados de distritos (ver consola).</p>';
    });
}
</script>
  
<script>
function carregarSismos() {
  fetch('https://api.ipma.pt/open-data/observation/seismic/3.json')
    .then(res => res.text())
    .then(texto => {
      try {
        const data = JSON.parse(texto);
        const sismos = Array.isArray(data.data) ? data.data.slice(0, 10) : [];
        const tbody = document.querySelector('#tabelaSismos tbody');
        tbody.innerHTML = '';

        sismos.forEach(sismo => {
          const linha = document.createElement('tr');
          linha.innerHTML = `
            <td>${sismo.time || '‚Äî'}</td>
            <td>${sismo.local && sismo.local.trim() !== '' ? sismo.local : '‚Äî'}</td>
            <td>${sismo.magnitud || '‚Äî'}</td>
            <td>${sismo.depth ? `${sismo.depth} km` : '‚Äî'}</td>
            <td>${sismo.lat} N, ${sismo.lon} W</td>
          `;
          tbody.appendChild(linha);
        });
      } catch (err) {
        console.error("‚ùå Erro ao interpretar os dados:", err);
        document.getElementById('sismos').innerHTML += '<p style="color:red;">‚ùå Dados s√≠smicos inv√°lidos.</p>';
      }
    })
    .catch(err => {
      console.error("‚ùå Erro na API de sismos:", err);
      document.getElementById('sismos').innerHTML += '<p style="color:red;">‚ùå Falha ao obter dados s√≠smicos.</p>';
    });
}

function mostrarRiscoIncendio() {
  const container = document.getElementById('riscoIncendio');
  container.innerHTML = `
    <h3>üî• Risco de Inc√™ndio Rural</h3>
    <p>Hoje, <strong>mais de 50 munic√≠pios</strong> est√£o em <span style="color:#d62728; font-weight:bold;">risco m√°ximo</span> de inc√™ndio, especialmente nos distritos de <strong>Bragan√ßa, Viseu, Guarda, Castelo Branco, Portalegre</strong> e <strong>Santar√©m</strong>.</p>
    <p>Outros <strong>50 munic√≠pios</strong> est√£o em <span style="color:#ff7f0e; font-weight:bold;">risco muito elevado</span>, incluindo zonas de <strong>Vila Real, Coimbra, Beja</strong> e <strong>Faro</strong>.</p>
    <p>Consulta o mapa oficial do IPMA para ver o risco por concelho:</p>
    <p><a href="https://www.ipma.pt/en/riscoincendio/rcm.pt/" target="_blank" style="font-weight:bold; color:#e15759;">üó∫Ô∏è Ver Mapa de Risco de Inc√™ndio</a></p>
  `;
}
</script>
</body>
</html>
